name: Debug Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  debug-build:
    # Only run this workflow when the commit message contains '[debug]'
    if: |
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[debug]')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.title, '[debug]'))
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, windows-latest] # ubuntu-latest temporarily disabled

    runs-on: ${{ matrix.platform }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check commit message (for debugging)
      shell: bash
      run: |
        echo "Event name: ${{ github.event_name }}"
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "Commit message: ${{ github.event.head_commit.message }}"
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "PR title: ${{ github.event.pull_request.title }}"
        fi
        echo "ğŸ› Building in DEBUG mode"

    - name: Install dependencies (ubuntu only)
      if: matrix.platform == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libwebkit2gtk-4.1-dev libgtk-3-dev libappindicator3-dev librsvg2-dev patchelf

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install frontend dependencies
      run: bun install

    - name: Build frontend for debug
      run: bun run build

    - name: Build Tauri app in debug mode
      run: |
        bun run tauri build -- --debug

    - name: Upload debug artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: claude-suite-debug-${{ matrix.platform }}
        path: |
          src-tauri/target/debug/bundle/
          src-tauri/target/debug/claude-suite*
        retention-days: 7
        
    - name: Display build info
      shell: bash
      run: |
        echo "ğŸ› Debug build completed for ${{ matrix.platform }}"
        echo "ğŸ“¦ Artifacts uploaded as: claude-suite-debug-${{ matrix.platform }}"
        echo "â° Retention: 7 days"
